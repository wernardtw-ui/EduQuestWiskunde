<!DOCTYPE html>
<html lang="af">
<head>
<meta charset="UTF-8" />
<title>EduQuestWiskunde – Graad 9 SA</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --card:#fff; --accent:#f59e0b;
    --ok:#10b981; --bad:#ef4444; --muted:#64748b;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:'Inter', sans-serif;
    background: radial-gradient(1200px 600px at 30% -10%, #1f2937, var(--bg));
    color:#e5e7eb; padding:24px;}
  h1{text-align:center; margin:0 0 16px;}
  .toolbar{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:16px;}
  .stat{display:flex; align-items:center;}
  .pill{padding:6px 12px; border-radius:999px; background:#0b1220; border:1px solid #1f2937;}
  .btn{appearance:none; border:none; border-radius:999px; padding:8px 16px; font-weight:700; cursor:pointer;
    transition:transform .2s, background .2s;}
  .btn.primary{background:var(--accent); color:var(--bg);}
  .btn.gemini{background: #50c48e; color: #0b1220;}
  .btn:hover{transform:scale(1.05);}
  .btn:disabled{opacity:.5; cursor:not-allowed; transform:none;}
  .pill.ok{color:var(--ok);}
  .pill.bad{color:var(--bad);}
  .controls-group{display:flex; flex-wrap:wrap; gap:12px;}
  .controls-group label, .controls-group select{
    font-size:14px; color:var(--muted); text-transform:uppercase; font-weight:bold;
  }
  .controls-group select{
    background:var(--panel); border-radius:6px; padding:4px 8px; border:1px solid #1f2937; color:#e5e7eb;
  }
  .controls-group option{color:#e5e7eb;}
  .question-panel{background:var(--panel); border-radius:12px; padding:24px; text-align:center; min-height:120px;
    display:flex; flex-direction:column; justify-content:center; align-items:center; box-shadow:0 8px 16px rgba(0,0,0,.3);}
  .question-text{font-size:24px; font-weight:700;}
  .question-hint{font-size:16px; color:var(--muted); margin-top:12px;}
  .game-area{display:flex; justify-content:center; align-items:center; gap:24px; margin-top:24px; flex-wrap:wrap; min-height:300px;}
  .card-container{
    display:flex; flex-direction:column; gap:12px; width:100%; max-width:250px;
    position:relative; z-index:1;
  }
  .card-container .title{text-align:center; font-weight:700;}
  .card-slot-area{
    min-height:200px; padding:12px; border-radius:12px;
    display:flex; flex-wrap:wrap; align-content:flex-start; justify-content:center;
    gap:8px;
  }
  .draw-pile{background:var(--panel); border:2px solid #1f2937; box-shadow:0 4px 8px rgba(0,0,0,.2);}
  .chain-area{
    display:flex; flex-direction:column; align-items:center; gap:12px;
    background:var(--panel); border-radius:12px; padding:24px;
    flex:1;
  }
  .chain-slots{display:flex; justify-content:center; gap:12px; flex-wrap:wrap;}
  .card{
    background:var(--card); color:var(--bg); padding:12px; border-radius:8px;
    font-weight:700; min-width:80px; text-align:center; cursor:pointer;
    transition:transform .2s, box-shadow .2s;
    box-shadow:0 2px 4px rgba(0,0,0,.1);
    white-space:nowrap;
  }
  .card:hover{transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,.2);}
  .card.dragging{opacity:0.5; transform:scale(0.9);}
  .card-slot{
    border:2px dashed var(--muted); border-radius:8px; padding:8px;
    min-width:100px; min-height:48px;
    display:flex; align-items:center; justify-content:center;
    transition:border-color .3s;
  }
  .card-slot.drag-over{border-color:var(--accent);}
  .card-slot.correct{border-color:var(--ok);}
  .card-slot.incorrect{border-color:var(--bad);}
  .card-slot .card{cursor:default;}
  .discard-pile{background:#293347; border:2px solid #3c4962; min-height:100px; min-width:100px;}
  .toast-container{
    position:fixed; bottom:24px; right:24px; z-index:100;
    display:flex; flex-direction:column; gap:8px; align-items:flex-end;
  }
  .toast{
    background:#333; color:#fff; padding:12px 24px; border-radius:999px;
    animation:fadeInOut 3s forwards; box-shadow:0 4px 8px rgba(0,0,0,.2);
  }
  @keyframes fadeInOut{
    0%{opacity:0; transform:translateY(20px);}
    10%{opacity:1; transform:translateY(0);}
    90%{opacity:1; transform:translateY(0);}
    100%{opacity:0; transform:translateY(20px);}
  }
  .user-info{
    background: var(--panel);
    padding: 8px 16px;
    border-radius: 999px;
    font-size: 12px;
    color: var(--muted);
    font-weight: bold;
    margin-bottom: 16px;
  }
  .game-stats {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }
  .score-info {
    font-size: 16px;
    font-weight: bold;
    color: var(--ok);
  }
  .score-label {
    font-size: 12px;
    color: var(--muted);
  }

  /* --- Mobile Optimizations --- */
  @media (max-width: 768px) {
    body {
      padding: 16px;
    }

    .toolbar {
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .question-panel {
      padding: 16px;
    }

    .question-text {
      font-size: 20px;
    }

    .game-area {
      flex-direction: column;
      gap: 16px;
      margin-top: 16px;
    }

    .card-container {
      max-width: none;
      width: 100%;
    }

    .chain-area {
      padding: 16px;
    }

    .chain-slots {
      gap: 8px;
    }
    
    .card {
      padding: 10px;
      font-size: 14px;
    }
  }
</style>
</head>
<body>

<div class="user-info">
  <span id="userIdDisplay">Gebruiker-ID laai...</span>
</div>

<h1>EduQuestWiskunde</h1>
<div class="toolbar">
  <div class="controls-group">
    <label for="categorySelect">Kategorie:</label>
    <select id="categorySelect"></select>
    <label for="difficultySelect">Moeilikheidsgraad:</label>
    <select id="difficultySelect"></select>
  </div>
  <div class="stat">
    <span class="pill">⏱ <span id="timerEl">60</span>s</span>
    <span class="pill ok">✅ <span id="correctScoreEl">0</span></span>
    <span class="pill bad">❌ <span id="incorrectScoreEl">0</span></span>
  </div>
</div>

<div class="question-panel">
  <div class="question-text" id="questionText"></div>
  <div class="question-hint" id="questionHint"></div>
</div>

<div class="game-area">
  <div class="card-container">
    <div class="title">Trekstapel</div>
    <div class="card-slot-area draw-pile" id="drawPile"></div>
  </div>

  <div class="chain-area">
    <div class="title">Oplossingsketting</div>
    <div class="chain-slots" id="chainSlots"></div>
  </div>

  <div class="card-container">
    <div class="title">Weggooi stapel</div>
    <div class="card-slot-area discard-pile" id="discardPile"></div>
  </div>
</div>

<div class="toolbar">
  <div class="controls-group">
    <button id="hintBtn" class="btn">Gee Wenk</button>
    <button id="geminiHintBtn" class="btn gemini">✨ Kletswenk</button>
    <button id="speakBtn" class="btn gemini">✨ Praat Vraag</button>
  </div>
  <div class="controls-group">
    <button id="restartBtn" class="btn primary">Herbegin</button>
    <button id="nextBtn" class="btn primary" disabled>Volgende Vraag</button>
  </div>
</div>

<div class="toast-container"></div>
<audio id="audioPlayer"></audio>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Data from questions.json embedded directly to avoid fetch errors
  const questionsData = [
    {
        "text": "Bereken: 1/4 + 3/8",
        "solution": [
            "Vind 'n gemeenskaplike noemer: 1/4 = 2/8.",
            "2/8 + 3/8 = 5/8.",
            "Antwoord: 5/8"
        ],
        "distractors": [
            "Antwoord: 4/12",
            "Antwoord: 1/2",
            "Antwoord: 4/8"
        ],
        "category": "Bewerkings met getalle",
        "difficulty": "Maklik"
    },
    {
        "text": "Bereken: 0.75 x 1.2",
        "solution": [
            "Vermenigvuldig 75 met 12, wat 900 is.",
            "Aangesien daar drie desimale plekke in totaal is (twee in 0.75 en een in 1.2), is die antwoord 0.900.",
            "Antwoord: 0.9"
        ],
        "distractors": [
            "Antwoord: 9.0",
            "Antwoord: 0.09",
            "Antwoord: 0.85"
        ],
        "category": "Bewerkings met getalle",
        "difficulty": "Medium"
    },
    {
        "text": "Wat is 15% van 240?",
        "solution": [
            "Omskep die persentasie na 'n desimale getal: 15% = 0.15.",
            "Vermenigvuldig 0.15 met 240.",
            "0.15 x 240 = 36.",
            "Antwoord: 36"
        ],
        "distractors": [
            "Antwoord: 15",
            "Antwoord: 24",
            "Antwoord: 360"
        ],
        "category": "Bewerkings met getalle",
        "difficulty": "Maklik"
    },
    {
        "text": "Die prys van 'n item is met 20% verlaag. Die nuwe prys is $80. Wat was die oorspronklike prys?",
        "solution": [
            "Die nuwe prys ($80) is 100% - 20% = 80% van die oorspronklike prys.",
            "Laat x die oorspronklike prys wees. 0.80x = 80.",
            "x = 80 / 0.80 = 100.",
            "Antwoord: $100"
        ],
        "distractors": [
            "Antwoord: $96",
            "Antwoord: $64",
            "Antwoord: $120"
        ],
        "category": "Bewerkings met getalle",
        "difficulty": "Moeilik"
    },
    {
        "text": "Die lengte van 'n reghoek is 5 cm meer as sy breedte. As die omtrek 30 cm is, wat is die lengte?",
        "solution": [
            "Laat w die breedte wees. Die lengte is w + 5.",
            "Omtrek = 2(w + l) = 2(w + w + 5) = 2(2w + 5) = 4w + 10.",
            "4w + 10 = 30 => 4w = 20 => w = 5.",
            "Lengte = w + 5 = 5 + 5 = 10.",
            "Antwoord: 10 cm"
        ],
        "distractors": [
            "Antwoord: 5 cm",
            "Antwoord: 8 cm",
            "Antwoord: 12.5 cm"
        ],
        "category": "Meetkunde en Meting - Omtrek",
        "difficulty": "Medium"
    },
    {
        "text": "'n Houer bevat 2.5 liter vloeistof. Hoeveel 250 ml glase kan daaruit gevul word?",
        "solution": [
            "Omskep liters na milliliter: 2.5 L = 2500 ml.",
            "Deel die totale volume deur die glasvolume: 2500 / 250.",
            "2500 / 250 = 10.",
            "Antwoord: 10 glase"
        ],
        "distractors": [
            "Antwoord: 100 glase",
            "Antwoord: 5 glase",
            "Antwoord: 25 glase"
        ],
        "category": "Meetkunde en Meting - Volume",
        "difficulty": "Maklik"
    },
    {
        "text": "Wat is die oppervlakte van 'n sirkel met 'n radius van 5 cm? (Gebruik $π ≈ 3.14$)",
        "solution": [
            "Die oppervlakte van 'n sirkel word gegee deur die formule $A = πr^2$.",
            "$A = 3.14 \\times (5)^2 = 3.14 \\times 25$.",
            "$A = 78.5$.",
            "Antwoord: 78.5 $cm^2$"
        ],
        "distractors": [
            "Antwoord: 15.7 $cm^2$",
            "Antwoord: 31.4 $cm^2$",
            "Antwoord: 10 $cm^2$"
        ],
        "category": "Meetkunde en Meting - Oppervlakte",
        "difficulty": "Medium"
    },
    {
        "text": "Die formule vir die volume van 'n sfeer is $V = \\frac{4}{3}πr^3$. Vind die volume van 'n sfeer met 'n radius van 3 m. (Gebruik $π ≈ 3.14$)",
        "solution": [
            "Vervang r = 3 in die formule: $V = \\frac{4}{3} \\times 3.14 \\times (3)^3$.",
            "$V = \\frac{4}{3} \\times 3.14 \\times 27$.",
            "$V = 4 \\times 3.14 \\times 9 = 113.04$.",
            "Antwoord: 113.04 $m^3$"
        ],
        "distractors": [
            "Antwoord: 36 $m^3$",
            "Antwoord: 84.78 $m^3$",
            "Antwoord: 150.72 $m^3$"
        ],
        "category": "Meetkunde en Meting - Volume",
        "difficulty": "Moeilik"
    },
    {
        "text": "Vind die waarde van x in die vergelyking $2x + 5 = 11$.",
        "solution": [
            "Trek 5 af van albei kante: $2x = 11 - 5$.",
            "Vereenvoudig: $2x = 6$.",
            "Deel deur 2: $x = 6 / 2 = 3$.",
            "Antwoord: x = 3"
        ],
        "distractors": [
            "Antwoord: x = 8",
            "Antwoord: x = 6",
            "Antwoord: x = 2"
        ],
        "category": "Getal en Algebra - Vergelykings",
        "difficulty": "Maklik"
    },
    {
        "text": "Los op vir y in die vergelyking $4(y - 2) = 12$.",
        "solution": [
            "Deel albei kante deur 4: $y - 2 = 12 / 4 = 3$.",
            "Tel 2 by albei kante: $y = 3 + 2 = 5$.",
            "Antwoord: y = 5"
        ],
        "distractors": [
            "Antwoord: y = 4",
            "Antwoord: y = 2",
            "Antwoord: y = 7"
        ],
        "category": "Getal en Algebra - Vergelykings",
        "difficulty": "Medium"
    },
    {
        "text": "Vind die waarde van x in die vergelyking $3x + 10 = x - 6$.",
        "solution": [
            "Trek x af van albei kante: $2x + 10 = -6$.",
            "Trek 10 af van albei kante: $2x = -16$.",
            "Deel deur 2: $x = -8$.",
            "Antwoord: x = -8"
        ],
        "distractors": [
            "Antwoord: x = -2",
            "Antwoord: x = 2",
            "Antwoord: x = 8"
        ],
        "category": "Getal en Algebra - Vergelykings",
        "difficulty": "Moeilik"
    },
    {
        "text": "Brei die uitdrukking uit: $(a + 3)(a - 2)$.",
        "solution": [
            "Gebruik die VOIL-metode: Eerste, Buitenste, Binne, Laaste.",
            "$(a)(a) + (a)(-2) + (3)(a) + (3)(-2) = a^2 - 2a + 3a - 6$.",
            "Kombineer gelyksoortige terme: $a^2 + a - 6$.",
            "Antwoord: $a^2 + a - 6$"
        ],
        "distractors": [
            "Antwoord: $a^2 - 6$",
            "Antwoord: $a^2 + 5a - 6$",
            "Antwoord: $a^2 + a + 6$"
        ],
        "category": "Getal en Algebra - Uitdrukkings",
        "difficulty": "Medium"
    },
    {
        "text": "Faktoriseer die uitdrukking: $x^2 + 7x + 12$.",
        "solution": [
            "Vind twee getalle wat tot 12 vermenigvuldig en tot 7 optel.",
            "Die getalle is 3 en 4 (aangesien $3 \\times 4 = 12$ en $3 + 4 = 7$).",
            "Die gefaktoriseerde vorm is $(x+3)(x+4)$.",
            "Antwoord: $(x+3)(x+4)$"
        ],
        "distractors": [
            "Antwoord: $(x+6)(x+2)$",
            "Antwoord: $(x+1)(x+12)$",
            "Antwoord: $(x-3)(x-4)$"
        ],
        "category": "Getal en Algebra - Uitdrukkings",
        "difficulty": "Moeilik"
    },
    {
        "text": "Wat is die gemene verskil van die reeks gedefinieer deur $T_n = 7 - 2n$?",
        "solution": [
            "Die gemene verskil in 'n lineêre reeks $T_n = dn+c$ is die koëffisiënt van n.",
            "Antwoord: -2"
        ],
        "distractors": [
            "Antwoord: 7",
            "Antwoord: 2",
            "Antwoord: 5"
        ],
        "category": "Getal en Algebra - Rye",
        "difficulty": "Medium"
    },
    {
        "text": "'n Aritmetiese reeks het 'n eerste term van -10 en 'n gemene verskil van 4. Vind die 5de term.",
        "solution": [
            "Gebruik die formule $T_n = a + (n-1)d$.",
            "$T_5 = -10 + (5-1) \\times 4 = -10 + 4 \\times 4 = -10 + 16$.",
            "Antwoord: 6"
        ],
        "distractors": [
            "Antwoord: 10",
            "Antwoord: -26",
            "Antwoord: 14"
        ],
        "category": "Getal en Algebra - Rye",
        "difficulty": "Maklik"
    },
    {
        "text": "'n Meetkundige reeks begin met 1000 en het 'n gemene verhouding van 0.1. Wat is die 4de term?",
        "solution": [
            "$T_1 = 1000$.",
            "$T_2 = 1000 \\times 0.1 = 100$.",
            "$T_3 = 100 \\times 0.1 = 10$.",
            "$T_4 = 10 \\times 0.1 = 1$.",
            "Antwoord: 1"
        ],
        "distractors": [
            "Antwoord: 10",
            "Antwoord: 0.01",
            "Antwoord: 0.1"
        ],
        "category": "Getal en Algebra - Rye",
        "difficulty": "Medium"
    },
    {
        "text": "'n Reeks word gedefinieer deur die reël Tn = 5n - 1. Wat is die 8ste term?",
        "solution": [
            "Vervang n = 8 in die reël.",
            "T8 = 5(8) - 1 = 40 - 1 = 39.",
            "Antwoord: 39"
        ],
        "distractors": [
            "Antwoord: 40",
            "Antwoord: 35",
            "Antwoord: 41"
        ],
        "category": "Rye",
        "difficulty": "Maklik"
    },
    {
        "text": "Die eerste term van 'n aritmetiese reeks is 25 en die 4de term is 16. Vind die gemene verskil.",
        "solution": [
            "Gebruik die formule Tn = a + (n-1)d. T4 = 25 + (4-1)d = 16.",
            "25 + 3d = 16.",
            "3d = 16 - 25 = -9.",
            "d = -3.",
            "Antwoord: -3"
        ],
        "distractors": [
            "Antwoord: 3",
            "Antwoord: -9",
            "Antwoord: 9"
        ],
        "category": "Rye",
        "difficulty": "Moeilik"
    },
    {
        "text": "Die 3de term van 'n meetkundige reeks is 12 en die gemene verhouding is 2. Wat is die eerste term?",
        "solution": [
            "Gebruik die formule $T_n = ar^{n-1}$. $T_3 = a \\times 2^{3-1} = 12$.",
            "$a \\times 2^2 = 12 \\implies a \\times 4 = 12$.",
            "Deel deur 4: $a = 3$.",
            "Antwoord: 3"
        ],
        "distractors": [
            "Antwoord: 6",
            "Antwoord: 1.5",
            "Antwoord: 24"
        ],
        "category": "Rye",
        "difficulty": "Moeilik"
    },
    {
        "text": "Bereken: 3 + 7",
        "solution": [
            "Tel 3 en 7 op",
            "Antwoord: 10"
        ],
        "distractors": [
            "Antwoord: -4",
            "Antwoord: 21",
            "Antwoord: 12"
        ],
        "category": "Bewerkings",
        "difficulty": "Maklik"
    },
    {
        "text": "Bereken: -18 - -8",
        "solution": [
            "Trek -8 van -18 af",
            "Antwoord: -10"
        ],
        "distractors": [
            "Antwoord: -26",
            "Antwoord: 10",
            "Antwoord: -9"
        ],
        "category": "Bewerkings",
        "difficulty": "Maklik"
    },
    {
        "text": "Bereken: -5 - -6",
        "solution": [
            "Trek -6 van -5 af",
            "Antwoord: 1"
        ],
        "distractors": [
            "Antwoord: -11",
            "Antwoord: -1",
            "Antwoord: 2"
        ],
        "category": "Bewerkings",
        "difficulty": "Maklik"
    },
    {
        "text": "Bereken: -5 + 9",
        "solution": [
            "Tel -5 en 9 op",
            "Antwoord: 4"
        ],
        "distractors": [
            "Antwoord: -14",
            "Antwoord: -45",
            "Antwoord: 6"
        ],
        "category": "Bewerkings",
        "difficulty": "Maklik"
    }
];

  // Firestore log level
  setLogLevel('debug');

  // --- Firebase and Firestore Setup ---
  let db, auth;
  let userId = 'loading...';
  let isAuthReady = false;
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const userIdDisplay = document.getElementById('userIdDisplay');

  // Firestore functions must be defined before they are called
  const saveScores = async () => {
    if (!isAuthReady) return;
    try {
      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/gameData/solitaireScores`);
      await setDoc(userDocRef, {
        correctScore: correctScore,
        incorrectScore: incorrectScore,
        lastUpdated: new Date()
      }, { merge: true });
      console.log("Scores saved successfully!");
    } catch (e) {
      console.error("Error saving scores:", e);
    }
  };

  const loadScores = async () => {
    if (!isAuthReady) return;
    try {
      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/gameData/solitaireScores`);
      const docSnap = await getDoc(userDocRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        correctScore = data.correctScore || 0;
        incorrectScore = data.incorrectScore || 0;
        correctScoreEl.textContent = correctScore;
        incorrectScoreEl.textContent = incorrectScore;
        console.log("Scores loaded successfully!");
      }
    } catch (e) {
      console.error("Error loading scores:", e);
    }
  };

  try {
      const firebaseConfig = JSON.parse(__firebase_config);
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      setPersistence(auth, browserSessionPersistence);
      
      onAuthStateChanged(auth, async (user) => {
          if (user) {
              userId = user.uid;
              userIdDisplay.textContent = `Gebruikers-ID: ${userId}`;
              isAuthReady = true;
              await loadScores();
          } else {
              userId = crypto.randomUUID();
              userIdDisplay.textContent = `Gebruikers-ID: ${userId}`;
              isAuthReady = true;
          }
      });

      if (typeof __initial_auth_token !== 'undefined') {
          await signInWithCustomToken(auth, __initial_auth_token);
      } else {
          await signInAnonymously(auth);
      }
  } catch (e) {
      console.error("Firebase initialization failed:", e);
      userIdDisplay.textContent = 'Auth failed, using temporary ID';
      userId = 'temp-user-' + crypto.randomUUID();
      isAuthReady = true;
  }

  // --- Game State & Elements ---
  const questionText = document.getElementById("questionText");
  const questionHint = document.getElementById("questionHint");
  const drawPile = document.getElementById("drawPile");
  const chainSlots = document.getElementById("chainSlots");
  const discardPile = document.getElementById("discardPile");
  const timerEl = document.getElementById("timerEl");
  const correctScoreEl = document.getElementById("correctScoreEl");
  const incorrectScoreEl = document.getElementById("incorrectScoreEl");
  const hintBtn = document.getElementById("hintBtn");
  const geminiHintBtn = document.getElementById("geminiHintBtn");
  const speakBtn = document.getElementById("speakBtn");
  const restartBtn = document.getElementById("restartBtn");
  const nextBtn = document.getElementById("nextBtn");
  const categorySelect = document.getElementById("categorySelect");
  const difficultySelect = document.getElementById("difficultySelect");
  const audioPlayer = document.getElementById("audioPlayer");

  let questions = [];
  let currentQuestion = null;
  let drawCards = [];
  let chainCards = [];
  let discardCards = [];
  let time = 60;
  let timerId = null;
  let correctScore = 0;
  let incorrectScore = 0;

  // --- Gemini API Call Functions ---
  const GEMINI_LLM_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
  const GEMINI_TTS_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=';
  const API_KEY = ''; // Leave this empty, it will be handled by the environment

  function base64ToArrayBuffer(base64) {
      const binaryString = window.atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes.buffer;
  }
  
  function pcmToWav(pcmData, sampleRate = 16000) {
      const buffer = new ArrayBuffer(44 + pcmData.length * 2);
      const view = new DataView(buffer);
      let offset = 0;

      // RIFF identifier
      view.setUint32(offset, 0x52494646, true); offset += 4;
      // file length
      view.setUint32(offset, 36 + pcmData.length * 2, true); offset += 4;
      // RIFF type
      view.setUint32(offset, 0x57415645, true); offset += 4;
      // format chunk identifier
      view.setUint32(offset, 0x666d7420, true); offset += 4;
      // format chunk length
      view.setUint32(offset, 16, true); offset += 4;
      // sample format (raw PCM)
      view.setUint16(offset, 1, true); offset += 2;
      // channel count
      view.setUint16(offset, 1, true); offset += 2;
      // sample rate
      view.setUint32(offset, sampleRate, true); offset += 4;
      // byte rate (sample rate * block align)
      view.setUint32(offset, sampleRate * 2, true); offset += 4;
      // block align
      view.setUint16(offset, 2, true); offset += 2;
      // bits per sample
      view.setUint16(offset, 16, true); offset += 2;
      // data chunk identifier
      view.setUint32(offset, 0x64617461, true); offset += 4;
      // data chunk length
      view.setUint32(offset, pcmData.length * 2, true); offset += 4;

      // write the PCM data
      for (let i = 0; i < pcmData.length; i++) {
          view.setInt16(offset, pcmData[i], true);
          offset += 2;
      }

      return new Blob([view], { type: 'audio/wav' });
  }

  async function getGeminiHint() {
      geminiHintBtn.disabled = true;
      const originalText = geminiHintBtn.textContent;
      geminiHintBtn.textContent = 'Wenk word gegenereer...';

      const nextEmptySlotIndex = chainCards.findIndex(c => c === null);
      if (nextEmptySlotIndex === -1) {
          toast("Alle stappe is voltooi!");
          geminiHintBtn.disabled = false;
          geminiHintBtn.textContent = originalText;
          return;
      }
      
      const prompt = `Die wiskunde-vraag is: "${currentQuestion.text}". Die oplossing word in stappe aangebied. Die eerste ${nextEmptySlotIndex} stappe is alreeds geplaas. Gee 'n kort, een-sin-wenk vir die volgende stap in die oplossing. Moenie die presiese antwoord gee nie, slegs 'n leidraad. Die wenk moet in Afrikaans wees.`;
      
      try {
          const payload = { contents: [{ parts: [{ text: prompt }] }] };
          const response = await fetch(GEMINI_LLM_API_URL + API_KEY, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
              throw new Error(`API error: ${response.statusText}`);
          }
          
          const result = await response.json();
          const hint = result?.candidates?.[0]?.content?.parts?.[0]?.text;
          if (hint) {
              questionHint.textContent = `✨ Gemini-wenk: ${hint}`;
          } else {
              toast("Kon nie 'n wenk genereer nie.");
          }
      } catch (error) {
          console.error("Error generating hint:", error);
          toast("Kon nie 'n wenk genereer nie. Probeer weer.");
      } finally {
          geminiHintBtn.disabled = false;
          geminiHintBtn.textContent = originalText;
      }
  }

  async function speakQuestion() {
    speakBtn.disabled = true;
    const originalText = speakBtn.textContent;
    speakBtn.textContent = 'Klank word gelaai...';

    const questionToSpeak = `Die vraag is: ${questionText.textContent}.`;
    
    const payload = {
        contents: [{ parts: [{ text: questionToSpeak }] }],
        generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
                voiceConfig: {
                    prebuiltVoiceConfig: { voiceName: "Iapetus" }
                }
            }
        },
    };

    try {
        const response = await fetch(GEMINI_TTS_API_URL + API_KEY, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`TTS API error: ${response.statusText}`);
        }

        const result = await response.json();
        const audioPart = result?.candidates?.[0]?.content?.parts?.[0];
        const audioData = audioPart?.inlineData?.data;
        const mimeType = audioPart?.inlineData?.mimeType;

        if (audioData && mimeType && mimeType.startsWith("audio/")) {
            const sampleRateMatch = mimeType.match(/rate=(\d+)/);
            const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);
            
            audioPlayer.src = audioUrl;
            audioPlayer.play();
            
            audioPlayer.onended = () => URL.revokeObjectURL(audioUrl);
        } else {
            toast("Kon nie klank genereer nie. Probeer weer.");
        }
    } catch (error) {
        console.error("Error speaking question:", error);
        toast("Fout met klankgenerering.");
    } finally {
        speakBtn.disabled = false;
        speakBtn.textContent = originalText;
    }
  }

  // --- Game Logic ---
  function loadQuestions() {
    questions = questionsData;
  }

  function initSelectors() {
    const categories = [...new Set(questions.map(q => q.category))];
    const difficulties = [...new Set(questions.map(q => q.difficulty))];

    // Add 'All' options
    categories.unshift("Alles");
    difficulties.unshift("Alles");

    categorySelect.innerHTML = '';
    difficulties.forEach(diff => {
      const option = document.createElement('option');
      option.value = diff;
      option.textContent = diff;
      difficultySelect.appendChild(option);
    });

    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      categorySelect.appendChild(option);
    });
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function loadQuestion() {
    // Clear previous state
    clearInterval(timerId);
    timerId = null;
    time = 60;
    timerEl.textContent = time;
    drawCards = [];
    chainCards = [];
    discardCards = [];
    nextBtn.disabled = true;
    questionHint.textContent = '';
    
    // Filter questions based on selected category and difficulty
    const selectedCategory = categorySelect.value;
    const selectedDifficulty = difficultySelect.value;
    const filteredQuestions = questions.filter(q =>
      (selectedCategory === 'Alles' || q.category === selectedCategory) &&
      (selectedDifficulty === 'Alles' || q.difficulty === selectedDifficulty)
    );
    
    // Select a random question
    if (filteredQuestions.length === 0) {
      toast("Geen vrae gevind vir hierdie keuse nie.");
      return;
    }
    currentQuestion = filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)];

    // Populate question and cards
    questionText.innerHTML = currentQuestion.text;

    // Create cards for solution and distractors
    const allCards = currentQuestion.solution.map((s, i) => ({
      id: `s-${i}`,
      text: s,
      isCorrect: true,
      originalIndex: i
    })).concat(
      currentQuestion.distractors.map((d, i) => ({
        id: `d-${i}`,
        text: d,
        isCorrect: false
      }))
    );
    shuffle(allCards);
    drawCards = allCards;
    chainCards = Array(currentQuestion.solution.length).fill(null);
    
    renderPiles();
    renderChainSlots();
    
    // Render math expressions
    if (typeof MathJax !== 'undefined') {
      MathJax.typesetPromise();
    }
  }

  function renderPiles() {
    drawPile.innerHTML = '';
    discardPile.innerHTML = '';

    drawCards.forEach(card => {
      const cardEl = createCardElement(card);
      drawPile.appendChild(cardEl);
    });
    
    discardCards.forEach(card => {
      const cardEl = createCardElement(card);
      discardPile.appendChild(cardEl);
    });
    
    // Re-render math expressions after new cards are added
    if (typeof MathJax !== 'undefined') {
      MathJax.typesetPromise();
    }
  }

  function renderChainSlots() {
    chainSlots.innerHTML = '';
    chainCards.forEach((card, index) => {
      const slot = document.createElement("div");
      slot.classList.add("card-slot");
      slot.dataset.index = index;
      slot.addEventListener("dragover", e => e.preventDefault());
      slot.addEventListener("drop", onSlotDrop);
      if (card) {
        const cardEl = createCardElement(card);
        slot.appendChild(cardEl);
      }
      chainSlots.appendChild(slot);
    });
    // Re-render math expressions after new slots are added
    if (typeof MathJax !== 'undefined') {
      MathJax.typesetPromise();
    }
  }
  
  function createCardElement(card) {
    const el = document.createElement("div");
    el.classList.add("card");
    el.textContent = card.text;
    el.draggable = true;
    el.dataset.id = card.id;
    el.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", card.id);
      e.dataTransfer.dropEffect = "move";
      setTimeout(() => el.classList.add("dragging"), 0);
    });
    el.addEventListener("dragend", () => el.classList.remove("dragging"));
    return el;
  }
  
  function onSlotDrop(e) {
    e.preventDefault();
    startTimerOnce();
    const slot = e.currentTarget;
    const cardId = e.dataTransfer.getData("text/plain");
    const card = drawCards.find(c => c.id === cardId);
    
    if (card) {
      const slotIndex = parseInt(slot.dataset.index, 10);
      
      // Check if the card is a valid next step
      let isCorrectOrder = false;
      if (card.isCorrect && card.originalIndex === slotIndex && chainCards[slotIndex] === null) {
        isCorrectOrder = true;
      }
      
      if (isCorrectOrder) {
        chainCards[slotIndex] = card;
        drawCards = drawCards.filter(c => c.id !== cardId);
        
        slot.innerHTML = '';
        const droppedCardEl = createCardElement(card);
        slot.appendChild(droppedCardEl);
        slot.classList.add("correct");
        
        checkWinCondition();
      } else {
        const cardEl = drawPile.querySelector(`[data-id='${cardId}']`);
        if(cardEl) {
          cardEl.remove();
        }
        discardCards.push(card);
        discardPile.appendChild(createCardElement(card));
        
        toast("❌ Verkeerde stap. Probeer weer.", 1500);
      }
      renderPiles();
    }
  }

  function checkWinCondition() {
    const allSlotsFilled = chainCards.every(card => card !== null);
    if (allSlotsFilled) {
      clearInterval(timerId);
      lockGame();
      correctScore++;
      correctScoreEl.textContent = correctScore;
      saveScores();
      toast("🎉 Korrek! Alle stappe is in plek.", 2500);
      nextBtn.disabled = false;
    }
  }

  function highlightHint() {
    if (chainCards.every(c => c !== null)) return;
    const nextEmptySlotIndex = chainCards.findIndex(c => c === null);
    
    if (nextEmptySlotIndex !== -1) {
      const hintText = currentQuestion.solution[nextEmptySlotIndex];
      questionHint.innerHTML = `Wenk: Vind die kaart wat sê "${hintText}" en plaas dit in die volgende leë gleuf.`;
    }
    toast("💡 Wenk onthul", 2500);
  }

  function startTimerOnce() {
    if (timerId) return;
    timerId = setInterval(() => {
      time--;
      timerEl.textContent = time;
      if (time <= 0) {
        clearInterval(timerId);
        lockGame();
        toast("⏱ Tyd is op!");
        nextBtn.disabled = false;
        incorrectScore++;
        incorrectScoreEl.textContent = incorrectScore;
        saveScores();
      }
    }, 1000);
  }

  function lockGame() {
    document.querySelectorAll(".card").forEach(el => el.draggable = false);
    document.querySelectorAll(".card-slot").forEach(slot => {
        slot.removeEventListener("drop", onSlotDrop);
        slot.classList.remove('drag-over');
    });
  }
  
  function toast(msg, duration = 3000) {
    const container = document.querySelector('.toast-container');
    const el = document.createElement('div');
    el.classList.add('toast');
    el.textContent = msg;
    container.appendChild(el);
    setTimeout(() => el.remove(), duration);
  }
  
  /* ===========================
     EVENT LISTENERS & INIT
  =========================== */
  hintBtn.addEventListener("click", highlightHint);
  geminiHintBtn.addEventListener("click", getGeminiHint);
  speakBtn.addEventListener("click", speakQuestion);
  restartBtn.addEventListener("click", loadQuestion);
  nextBtn.addEventListener("click", loadQuestion);
  categorySelect.addEventListener("change", loadQuestion);
  difficultySelect.addEventListener("change", loadQuestion);
  
  drawPile.addEventListener("dragover", e => e.preventDefault());
  drawPile.addEventListener("drop", e => {
    e.preventDefault();
    const cardId = e.dataTransfer.getData("text/plain");
    const cardIndex = discardCards.findIndex(c => c.id === cardId);
    if (cardIndex !== -1) {
      const card = discardCards.splice(cardIndex, 1)[0];
      drawCards.push(card);
      renderPiles();
      toast("✅ Stap herstel - probeer weer!", 1200);
    }
  });
  
  // Initialize
  window.onload = function() {
    loadQuestions();
    initSelectors();
    loadQuestion();
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('Service Worker registered', reg))
        .catch(err => console.error('Service Worker registration failed', err));
    }
  };
  
</script>

</body>
</html>
